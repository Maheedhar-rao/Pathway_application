<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harvest Lending X Pathway Catalyst — Application Form</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
 <header class="pc-header">
  <div class="brand">
    <div class="brand-left">
      <div class="logo-wrap">
        <img
          src="{{ url_for('static', filename='pathway-logo.png') }}"
          alt="Pathway Catalyst Logo"
          class="logo"
          loading="eager"
        />
      </div>

      <div class="brand-text">
        <span class="badge">Harvest Lending X Pathway Catalyst</span>
        <h1>Business Financing Application</h1>
        <p class="lead">Fast, secure, and confidential submission.</p>
      </div>
    </div>
  </div>
</header>


  <main class="container">
    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step active" data-step="1">
        <span class="step-num">1</span>
        <span>Business Info</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="2">
        <span class="step-num">2</span>
        <span>Owner Details</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="3">
        <span class="step-num">3</span>
        <span>Property</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="4">
        <span class="step-num">4</span>
        <span>Documents</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="5">
        <span class="step-num">5</span>
        <span>Submit</span>
      </div>
    </div>

    {% if errors %}
    <div class="error-summary" id="errorSummary">
      <h3>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Please fix the following errors
      </h3>
      <ul>
        {% for field, msg in errors.items() %}
        <li><strong>{{ field.replace('_', ' ').title() }}:</strong> {{ msg }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Form -->
    <form id="appForm"
          class="card"
          action="{{ url_for('submit') }}"
          method="POST"
          enctype="multipart/form-data"
          autocomplete="off">
      <!-- Hidden rep tracking field (HMAC-signed to prevent tampering) -->
      {% if rep_code %}
      <input type="hidden" name="rep_code" value="{{ rep_code }}" />
      <input type="hidden" name="rep_sig" value="{{ rep_sig }}" />
      {% endif %}

      <div class="card-header">
        <h2>Applicant Details</h2>
        {% if rep_info %}
        <span class="pill" style="background: rgba(52, 211, 153, 0.15); border-color: rgba(52, 211, 153, 0.3); color: #34d399;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          Rep: {{ rep_info.name }}
        </span>
        {% else %}
        <span class="pill">Draft</span>
        {% endif %}
      </div>

      <div class="card-body">
        <!-- Business Information -->
        <div class="section-title"><span class="dot"></span><h3>Business Information</h3></div>
        <div class="grid cols-2">
          <div class="field">
            <label>Business Legal Name</label>
            <input name="business_legal_name"
                   value="{{ (form.get('business_legal_name') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>Business D/B/A Name</label>
            <input name="business_dba"
                   value="{{ (form.get('business_dba') if form else '') }}" />
          </div>
          <div class="field">
            <label>Industry</label>
            <input name="industry"
                   placeholder="e.g., Home Construction"
                   value="{{ (form.get('industry') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>Legal Entity</label>
            <select name="legal_entity" required>
              <option value="">Select entity type</option>
              <option value="Sole Proprietorship" {% if form and form.get('legal_entity')=='Sole Proprietorship' %}selected{% endif %}>Sole Proprietorship</option>
              <option value="LLC" {% if form and form.get('legal_entity')=='LLC' %}selected{% endif %}>LLC</option>
              <option value="Corporation (C)" {% if form and form.get('legal_entity')=='Corporation (C)' %}selected{% endif %}>Corporation (C)</option>
              <option value="Corporation (S)" {% if form and form.get('legal_entity')=='Corporation (S)' %}selected{% endif %}>Corporation (S)</option>
              <option value="Partnership" {% if form and form.get('legal_entity')=='Partnership' %}selected{% endif %}>Partnership</option>
              <option value="Nonprofit" {% if form and form.get('legal_entity')=='Nonprofit' %}selected{% endif %}>Nonprofit</option>
            </select>
          </div>
          <div class="field">
            <label>Business Start Date</label>
            <input type="date"
                   name="business_start_date"
                   value="{{ (form.get('business_start_date') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>EIN</label>
            <input name="ein"
                   placeholder="12-3456789"
                   value="{{ (form.get('ein') if form else '') }}"
                   required
                   autocomplete="off"
                   inputmode="numeric" />
          </div>

          <!-- Added: Company Website -->
          <div class="field">
            <label>Company Website</label>
            <input type="url"
                   name="company_website"
                   placeholder="https://example.com"
                   value="{{ (form.get('company_website') if form else '') }}" />
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:12px">
          <div class="field">
            <label>Company Address</label>
            <input name="company_address1"
                   list="addr_suggestions"
                   autocomplete="street-address"
                   value="{{ (form.get('company_address1') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <input name="company_address2"
                   placeholder="Suite / Apt"
                   value="{{ (form.get('company_address2') if form else '') }}" />
          </div>
          <div class="field">
            <label>City</label>
            <input name="company_city"
                   autocomplete="address-level2"
                   value="{{ (form.get('company_city') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>State</label>
            <input name="company_state"
                   autocomplete="address-level1"
                   value="{{ (form.get('company_state') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>ZIP</label>
            <input name="company_zip"
                   autocomplete="postal-code"
                   value="{{ (form.get('company_zip') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>Country</label>
            <input name="company_country"
                   value="{{ (form.get('company_country') if form else 'United States') }}" />
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:12px">
          <div class="field">
            <label>Business Phone</label>
            <input name="business_phone"
                   value="{{ (form.get('business_phone') if form else '') }}" />
          </div>
          <div class="field">
            <label>Requested Loan Amount</label>
            <input type="number"
                   name="loan_amount"
                   min="0"
                   step="100"
                   value="{{ (form.get('loan_amount') if form else '') }}"
                   required />
          </div>
          <div class="field">
            <label>Loan Purpose</label>
            <input name="loan_purpose"
                   placeholder="e.g., Working capital, equipment"
                   value="{{ (form.get('loan_purpose') if form else '') }}" />
          </div>
        </div>

        <!-- Owner Information -->
        <div class="section-title"><span class="dot"></span><h3>Owner Information</h3></div>
        <div id="owners">
          <div class="grid cols-3">
            <div class="field">
              <label>Owner First Name</label>
              <input name="owner_0_first"
                     value="{{ (form.get('owner_0_first') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>Owner Last Name</label>
              <input name="owner_0_last"
                     value="{{ (form.get('owner_0_last') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>Ownership %</label>
              <input type="number"
                     name="owner_0_pct"
                     min="0"
                     max="100"
                     step="0.1"
                     value="{{ (form.get('owner_0_pct') if form else '') }}"
                     required />
            </div>
          </div>

          <div class="grid cols-3" style="margin-top:12px">
            <div class="field">
              <label>DOB</label>
              <input type="date"
                     name="owner_0_dob"
                     value="{{ (form.get('owner_0_dob') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>SSN</label>
              <input name="owner_0_ssn"
                     placeholder="123-45-6789"
                     value="{{ (form.get('owner_0_ssn') if form else '') }}"
                     required
                     autocomplete="new-password"
                     inputmode="numeric" />
            </div>
            <div class="field">
              <label>Email</label>
              <input type="email"
                     name="owner_0_email"
                     value="{{ (form.get('owner_0_email') if form else '') }}"
                     required
                     autocomplete="off" />
            </div>
          </div>

          <div class="grid cols-3" style="margin-top:12px">
            <div class="field">
              <label>Mobile</label>
              <input name="owner_0_mobile"
                     placeholder="(555) 555-5555"
                     value="{{ (form.get('owner_0_mobile') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>Home Address</label>
              <input name="owner_0_addr1"
                     list="addr_suggestions"
                     autocomplete="street-address"
                     value="{{ (form.get('owner_0_addr1') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <input name="owner_0_addr2"
                     placeholder="Suite / Apt"
                     value="{{ (form.get('owner_0_addr2') if form else '') }}" />
            </div>
            <div class="field">
              <label>City</label>
              <input name="owner_0_city"
                     autocomplete="address-level2"
                     value="{{ (form.get('owner_0_city') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>State</label>
              <input name="owner_0_state"
                     autocomplete="address-level1"
                     value="{{ (form.get('owner_0_state') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>ZIP</label>
              <input name="owner_0_zip"
                     autocomplete="postal-code"
                     value="{{ (form.get('owner_0_zip') if form else '') }}"
                     required />
            </div>
            <div class="field">
              <label>Country</label>
              <input name="owner_0_country"
                     value="{{ (form.get('owner_0_country') if form else 'United States') }}" />
            </div>
          </div>

          <!-- Added: Owner 0 FICO + MCA Balances -->
          <div class="grid cols-3" style="margin-top:12px">
            <div class="field">
              <label>FICO</label>
              <input type="number"
                     name="owner_0_fico"
                     min="300"
                     max="850"
                     value="{{ (form.get('owner_0_fico') if form else '') }}" />
            </div>
            <div class="field">
              <label>MCA Balances</label>
              <input name="owner_0_mca_balances"
                     placeholder="If any, describe balances or total"
                     value="{{ (form.get('owner_0_mca_balances') if form else '') }}" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <div class="helper" style="opacity:.7;font-size:.9rem;margin-top:10px;">
                Optional
              </div>
            </div>
          </div>

          <!-- Added: Add Owner toggle -->
          <div class="grid cols-3" style="margin-top:16px">
            <div class="field">
              <label>Add Owner</label>
              <select name="has_owner_1" id="has_owner_1">
                <option value="No" {% if form and form.get('has_owner_1')=='No' %}selected{% endif %}>No</option>
                <option value="Yes" {% if form and form.get('has_owner_1')=='Yes' %}selected{% endif %}>Yes</option>
              </select>
            </div>
          </div>

          <!-- Added: Second Owner section -->
          <div id="owner1Section" style="display:none; margin-top:14px;">
            <div class="section-title"><span class="dot"></span><h3>Second Owner</h3></div>

            <div class="grid cols-3">
              <div class="field">
                <label>Owner First Name</label>
                <input name="owner_1_first"
                       value="{{ (form.get('owner_1_first') if form else '') }}" />
              </div>
              <div class="field">
                <label>Owner Last Name</label>
                <input name="owner_1_last"
                       value="{{ (form.get('owner_1_last') if form else '') }}" />
              </div>
              <div class="field">
                <label>Ownership %</label>
                <input type="number"
                       name="owner_1_pct"
                       min="0"
                       max="100"
                       step="0.1"
                       value="{{ (form.get('owner_1_pct') if form else '') }}" />
              </div>
            </div>

            <div class="grid cols-3" style="margin-top:12px">
              <div class="field">
                <label>DOB</label>
                <input type="date"
                       name="owner_1_dob"
                       value="{{ (form.get('owner_1_dob') if form else '') }}" />
              </div>
              <div class="field">
                <label>SSN</label>
                <input name="owner_1_ssn"
                       placeholder="123-45-6789"
                       value="{{ (form.get('owner_1_ssn') if form else '') }}"
                       autocomplete="new-password"
                       inputmode="numeric" />
              </div>
              <div class="field">
                <label>Email</label>
                <input type="email"
                       name="owner_1_email"
                       value="{{ (form.get('owner_1_email') if form else '') }}"
                       autocomplete="off" />
              </div>
            </div>

            <div class="grid cols-3" style="margin-top:12px">
              <div class="field">
                <label>Mobile</label>
                <input name="owner_1_mobile"
                       placeholder="(555) 555-5555"
                       value="{{ (form.get('owner_1_mobile') if form else '') }}" />
              </div>
              <div class="field">
                <label>Home Address</label>
                <input name="owner_1_addr1"
                       list="addr_suggestions"
                       autocomplete="street-address"
                       value="{{ (form.get('owner_1_addr1') if form else '') }}" />
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <input name="owner_1_addr2"
                       placeholder="Suite / Apt"
                       value="{{ (form.get('owner_1_addr2') if form else '') }}" />
              </div>

              <div class="field">
                <label>City</label>
                <input name="owner_1_city"
                       autocomplete="address-level2"
                       value="{{ (form.get('owner_1_city') if form else '') }}" />
              </div>
              <div class="field">
                <label>State</label>
                <input name="owner_1_state"
                       autocomplete="address-level1"
                       value="{{ (form.get('owner_1_state') if form else '') }}" />
              </div>
              <div class="field">
                <label>ZIP</label>
                <input name="owner_1_zip"
                       autocomplete="postal-code"
                       value="{{ (form.get('owner_1_zip') if form else '') }}" />
              </div>

              <div class="field">
                <label>Country</label>
                <input name="owner_1_country"
                       value="{{ (form.get('owner_1_country') if form else 'United States') }}" />
              </div>
            </div>

            <div class="grid cols-3" style="margin-top:12px">
              <div class="field">
                <label>FICO</label>
                <input type="number"
                       name="owner_1_fico"
                       min="300"
                       max="850"
                       value="{{ (form.get('owner_1_fico') if form else '') }}" />
              </div>
              <div class="field">
                <label>MCA Balances</label>
                <input name="owner_1_mca_balances"
                       placeholder="If any, describe balances or total"
                       value="{{ (form.get('owner_1_mca_balances') if form else '') }}" />
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <div class="helper" style="opacity:.7;font-size:.9rem;margin-top:10px;">
                  Optional
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Property and Location -->
        <div class="section-title"><span class="dot"></span><h3>Property and Location</h3></div>

        <div class="grid cols-3">
          <div class="field">
            <label>Own Real Estate?</label>
            <select name="own_real_estate" required>
              <option value="">Select</option>
              <option value="Yes" {% if form and form.get('own_real_estate')=='Yes' %}selected{% endif %}>Yes</option>
              <option value="No" {% if form and form.get('own_real_estate')=='No' %}selected{% endif %}>No</option>
            </select>
          </div>
          <div class="field">
            <label>Own Home Location?</label>
            <select name="own_home_location" required>
              <option value="">Select</option>
              <option value="Yes" {% if form and form.get('own_home_location')=='Yes' %}selected{% endif %}>Yes</option>
              <option value="No" {% if form and form.get('own_home_location')=='No' %}selected{% endif %}>No</option>
            </select>
          </div>
          <div class="field">
            <label>Own Business Location?</label>
            <select name="own_business_location" required>
              <option value="">Select</option>
              <option value="Yes" {% if form and form.get('own_business_location')=='Yes' %}selected{% endif %}>Yes</option>
              <option value="No" {% if form and form.get('own_business_location')=='No' %}selected{% endif %}>No</option>
            </select>
          </div>
        </div>

        <!-- Conditionally shown when Yes -->
        <div class="grid cols-3" id="tenureSection" style="display:none;">
          <br /><br />
          <div class="field">
            <label>Residence</label>
            <div class="inline">
              <label class="inline">
                <input type="radio" name="residence_tenure" value="Own" {% if form and form.get('residence_tenure')=='Own' %}checked{% endif %} />
                Own
              </label>
              <label class="inline">
                <input type="radio" name="residence_tenure" value="Rent" {% if form and form.get('residence_tenure')=='Rent' %}checked{% endif %} />
                Rent
              </label>
            </div>
          </div>
          <div class="field">
            <label>Business Location</label>
            <div class="inline">
              <label class="inline">
                <input type="radio" name="business_location_tenure" value="Own" {% if form and form.get('business_location_tenure')=='Own' %}checked{% endif %} />
                Own
              </label>
              <label class="inline">
                <input type="radio" name="business_location_tenure" value="Rent" {% if form and form.get('business_location_tenure')=='Rent' %}checked{% endif %} />
                Rent
              </label>
            </div>
          </div>
        </div>

        <!-- Uploads -->
        <div class="section-title"><span class="dot"></span><h3>Upload Bank Statements</h3></div>
        <div class="uploader">
          <p>Upload PDFs (you can select multiple)</p>
          <input id="bank_files" name="bank_files" type="file" accept="application/pdf" multiple required />
        </div>

        <!-- Authorization + Hand Signature -->
        <div class="section-title" style="margin-top:18px">
          <span class="dot"></span><h3>Authorization &amp; Signature</h3>
        </div>

        <div class="card" style="margin: 12px 0; padding: 14px;">
          <p style="margin:0; font-size:.95rem; line-height:1.45;">
            By submitting this application, you authorize Pathway Catalyst and its partners to contact you and obtain
            information necessary to evaluate financing options. You also acknowledge and agree to electronic records
            and signatures as permitted under applicable law.
          </p>

          <label class="inline" style="align-items:flex-start; gap:10px; margin-top:12px;">
            <input type="checkbox"
                   name="esign_consent"
                   value="Yes"
                   required
                   {% if form and form.get('esign_consent')=='Yes' %}checked{% endif %} />
            <span>I agree and provide my electronic signature.</span>
          </label>
        </div>

        <!-- Signature Pad -->
        <div class="signature-section">
          <div class="grid cols-2" style="gap:20px;align-items:start;">
            <div class="field">
              <label>Sign Below <span style="color:var(--danger);">*</span></label>
              <div class="sig-pad-wrap">
                <canvas id="signatureCanvas" width="480" height="180"></canvas>
                <button type="button" id="clearSigBtn" class="btn-clear-sig" title="Clear signature">Clear</button>
              </div>
              <input type="hidden" name="signature_data" id="signatureData" required />
              <p class="sig-hint">Use your mouse or finger to sign above</p>
            </div>
            <div class="field">
              <label>Date of Signature <span style="color:var(--danger);">*</span></label>
              <input type="date"
                     name="signature_date"
                     id="signatureDate"
                     value="{{ (form.get('signature_date') if form else '') }}"
                     required />
              <div style="margin-top:16px;">
                <label>Print Name <span style="color:var(--danger);">*</span></label>
                <input name="signature_print_name"
                       placeholder="Full legal name"
                       value="{{ (form.get('signature_print_name') if form else '') }}"
                       required />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn primary" id="submitBtn">
          <span>Submit Application</span>
        </button>
      </div>
    </form>

    <datalist id="addr_suggestions"></datalist>
  </main>

  <!-- Your script file if you have other logic -->
  <script src="{{ url_for('static', filename='form.js') }}"></script>

  <!-- Toggle and refresh logic -->
  <script>
    // Show or hide Residence and Business Location based on Own Real Estate
    (function () {
      const ownSel  = document.querySelector('select[name="own_real_estate"]');
      const section = document.getElementById('tenureSection');
      if (!ownSel || !section) return;

      const inputs = section.querySelectorAll(
        'input[name="residence_tenure"], input[name="business_location_tenure"]'
      );

      function update() {
        const show = ownSel.value === 'Yes';
        if (show) {
          section.style.display = 'grid';
          inputs.forEach(i => i.disabled = false);
        } else {
          section.style.display = 'none';
          inputs.forEach(i => { i.disabled = true; i.checked = false; });
        }
      }

      ownSel.addEventListener('change', update);

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', update);
      } else {
        update();
      }

      window.addEventListener('pageshow', function (e) {
        if (e.persisted) update();
      });
    })();

    // Toggle Second Owner section
    (function () {
      const sel = document.getElementById('has_owner_1');
      const sec = document.getElementById('owner1Section');
      if (!sel || !sec) return;

      const owner1Inputs = sec.querySelectorAll('input, select, textarea');

      function updateOwner1() {
        const show = sel.value === 'Yes';
        sec.style.display = show ? 'block' : 'none';
        owner1Inputs.forEach(el => {
          el.disabled = !show;
          if (!show && (el.type === 'checkbox' || el.type === 'radio')) el.checked = false;
          if (!show && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') && el.type !== 'hidden') el.value = '';
          if (!show && el.tagName === 'SELECT') el.selectedIndex = 0;
        });
      }

      sel.addEventListener('change', updateOwner1);

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateOwner1);
      } else {
        updateOwner1();
      }

      window.addEventListener('pageshow', function (e) {
        if (e.persisted) updateOwner1();
      });
    })();

    // Clear form on refresh and back/forward unless rendering validation errors
    (function () {
      const form = document.getElementById('appForm');
      if (!form) return;

      const hasErrors = {{ 'true' if errors else 'false' }};

      function shouldResetOnLoad() {
        if (hasErrors) return false;
        try {
          const nav = performance.getEntriesByType('navigation')[0];
          if (!nav) return true;
          return (nav.type === 'reload' || nav.type === 'back_forward');
        } catch (_) {
          return performance && performance.navigation && performance.navigation.type === 1;
        }
      }

      window.addEventListener('pageshow', function (e) {
        if (!hasErrors && e.persisted) form.reset();
      });

      if (shouldResetOnLoad()) {
        form.reset();
      }

      window.addEventListener('beforeunload', function () {
        try { form.reset(); } catch (_) {}
      });
    })();

    // ── Signature Pad ──
    (function () {
      const canvas = document.getElementById('signatureCanvas');
      const hiddenInput = document.getElementById('signatureData');
      const clearBtn = document.getElementById('clearSigBtn');
      const dateInput = document.getElementById('signatureDate');
      const wrap = canvas ? canvas.parentElement : null;
      if (!canvas || !hiddenInput) return;

      const ctx = canvas.getContext('2d');
      let drawing = false;
      let hasSigned = false;

      // High-DPI scaling
      function scaleCanvas() {
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        // Pen settings
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
      }
      scaleCanvas();
      window.addEventListener('resize', function () {
        const data = hasSigned ? canvas.toDataURL('image/png') : null;
        scaleCanvas();
        if (data && hasSigned) {
          const img = new window.Image();
          img.onload = function () {
            const rect = canvas.getBoundingClientRect();
            ctx.drawImage(img, 0, 0, rect.width, rect.height);
          };
          img.src = data;
        }
      });

      // Auto-fill today's date if empty
      if (dateInput && !dateInput.value) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        dateInput.value = y + '-' + m + '-' + d;
      }

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }

      function startDraw(e) {
        e.preventDefault();
        drawing = true;
        if (wrap) wrap.classList.add('signing');
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }

      function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        hasSigned = true;
      }

      function endDraw(e) {
        if (!drawing) return;
        e.preventDefault();
        drawing = false;
        if (wrap) wrap.classList.remove('signing');
        if (hasSigned) {
          if (wrap) wrap.classList.add('has-sig');
          hiddenInput.value = canvas.toDataURL('image/png');
        }
      }

      // Mouse events
      canvas.addEventListener('mousedown', startDraw);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', endDraw);
      canvas.addEventListener('mouseleave', endDraw);

      // Touch events
      canvas.addEventListener('touchstart', startDraw, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', endDraw);
      canvas.addEventListener('touchcancel', endDraw);

      // Clear button
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          const rect = canvas.getBoundingClientRect();
          ctx.clearRect(0, 0, rect.width, rect.height);
          hasSigned = false;
          hiddenInput.value = '';
          if (wrap) wrap.classList.remove('has-sig');
        });
      }

      // Before submit — ensure signature is captured
      const form = document.getElementById('appForm');
      if (form) {
        form.addEventListener('submit', function (e) {
          if (!hasSigned || !hiddenInput.value) {
            e.preventDefault();
            alert('Please sign the application before submitting.');
            canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
          }
        });
      }
    })();
  </script>
</body>
</html>
